---
title: "Process BibTeX file"
author: "Dan Villarreal"
date: "2023-06-29"
output: github_document
# output: 
  # html_document:
  #   code_folding: show
  #   df_print: paged
params:
  inbib: My-Pubs.bib
  outbib: Villarreal-Pubs.bib
  outcsv: My-Pubs.csv
  outrds: My-Pubs.Rds
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, comment="")

library(tidyverse)
library(bib2df)
library(xfun)
```

```{css, echo=FALSE}
/* Add scrollbars to long R input/output blocks */
pre {
  max-height: 300px;
  overflow-y: auto;
}
```

# Intro

This document contains code that takes a bibfile and outputs several files for different purposes:

- **`r params$outbib`**: A bibfile that doesn't have extra info, meant for folks who want to download my bibliography. It excludes some categories of publications (book reviews) as well as works in progress
- **`r params$outrds`**: An Rds file that has all the info needed to format website contents: CV, project pages, etc. This will take the place of `publications.tsv` in the publication-data-processing workflow
- **`r params$outcsv`**: A fallback csv file with most of the info in `r params$outrds`, but formatted a little nicer




# Parse input bibfile as dataframe

Read BibTeX file as df (suppress inaccurate "NAs introduced by coercion" warning)

```{r, warning=FALSE}
pubs <- bib2df(params$inbib)
```


Handle extra fields

```{r}
##Permissible extra fields
extraFields <- c("dontinclude", "project", "repo", "data", "gradauth", 
                 "undergradauth", "heading","pubnote")

##Parse vector of extras into list of dataframes
parse_extra <- function(x, permissible=extraFields) {
  library(dplyr)
  library(stringr)
  library(purrr)
  
  x %>% 
    ##Split into indiv extra fields
    str_split(";;;") %>%
    ##Filter out impermissible fields
    map(str_subset, paste0("^(", paste(permissible, collapse="|"), "):")) %>% 
    ##Get df of name and value
    map(~ as.data.frame(str_match(.x, "(?<name>.+): (?<value>.+)"))) %>% 
    ##Remove "whole-match" col
    map(select, -1)
}

##Add extra columns
pubs <- pubs %>% 
  ##Turn NOTE into list-col
  mutate(across(NOTE, parse_extra)) %>% 
  ##Pull out name-value pairs
  unnest(NOTE, keep_empty=TRUE) %>% 
  ##Each field in its own column
  pivot_wider() %>% 
  ##Remove NA column
  select(-"NA")
```

Heading logic


```{r}
patchYear <- tibble(YEAR = c("in prep", "under review", 
                             "revisions in prep", "revisions under review", 
                             "forthcoming"),
                    heading = "Works in progress")
patchCategory <- tribble(
  ~CATEGORY, ~heading,
  "ARTICLE", "Peer-reviewed publications",
  "INCOLLECTION", "Publications in edited volumes",
  "INPROCEEDINGS", "Publications in conference proceedings",
  "PHDTHESIS", "PhD dissertation",
  "MISC", "Open research tools" ##Dataset, Software
)
matchHeading <- c(
  "peer-reviewed" ~ "Peer-reviewed publications",
  "proceedings" ~ "Publications in conference proceedings",
  "book-review" ~ "Book reviews",
  "open-tools" ~ "Open research tools"
)

pubs <- pubs %>% 
  ##Recode heading
  mutate(across(heading, ~ case_match(.x, !!!matchHeading, .default=.x))) %>% 
  ##Patch based on YEAR first, then CATEGORY
  rows_patch(patchYear, "YEAR", unmatched="ignore") %>% 
  rows_patch(patchCategory, "CATEGORY", unmatched="error")
```


Handle PDF attachments (`FILE`)

```{r}
pubs <- pubs %>% 
  ##Point FILE paths to website URL
  mutate(across(FILE, ~ paste0("/pubs/", .x)),
         ##PDFs only
         across(FILE, ~ if_else(endsWith(.x, ".pdf"), .x, NA_character_)))
```


Turn URL, project, gradauth, & undergradauth into list-columns

```{r}
pubs <- pubs %>% 
  mutate(across(URL, ~ str_split(.x, " and ")),
         across(c(project, contains("gradauth")), ~ str_split(.x, ",")))
```


Replace temporary `;;;` with newlines

```{r}
pubs <- pubs %>% 
  mutate(across(where(is.atomic), ~ str_replace_all(.x, ";;;", "\n")))
```


Add asterisks to `AUTHOR` (\* = grad/professional student co-author, \*\* = undergrad)

```{r}
addStar <- function(x, oneStar, twoStar, starAfter=c("last","end")) {
  library(dplyr)
  starAfter <- match.arg(starAfter)
  star <- case_when(str_remove(x, ",.+") %in% oneStar ~ "*",
                    str_remove(x, ",.+") %in% twoStar ~ "**",
                    TRUE ~ "")
  
  if (starAfter=="last") {
    ##Last*, First
    str_replace(x, ",", paste0(star, ","))
  } else {
    ##Last, First*
    paste0(x, star)
  }
}

pubs <- pubs %>%
  mutate(across(AUTHOR, ~ pmap(list(x=.x, oneStar=gradauth, twoStar=undergradauth),
                               addStar)))
```



# Write simplified BibTeX

Remove extra info

```{r}
bibPubs <- 
  pubs %>% 
  ##No reviews or WIP
  filter(!(heading %in% c("Book reviews", "Works in progress"))) %>% 
  ##No fields unpacked from NOTE
  select(matches("^[A-Z]+$", ignore.case=FALSE))
```


Override `bib2df::df2bib()` to use UTF-8 encoding (via `xfun::write_utf8()`)

```{r}
df2bib <- function (x, file = "", append = FALSE, allfields = TRUE) {
  library(bib2df)
  library(xfun)
  
  if (!is.character(file)) {
    stop("Invalid file path: Non-character supplied.", call. = FALSE)
  }
  if (as.numeric(file.access(dirname(file), mode = 2)) != 
    0 && file != "") {
    stop("Invalid file path: File is not writeable.", call. = FALSE)
  }
  if (any({
    df_elements <- sapply(x$AUTHOR, inherits, "data.frame")
  })) {
    x$AUTHOR[df_elements] <- lapply(x$AUTHOR[df_elements], 
      na_replace)
    x$AUTHOR[df_elements] <- lapply(x$AUTHOR[df_elements], 
      function(x) {
        paste(x$last_name, ", ", x$first_name, " ", 
          x$middle_name, sep = "")
      })
    x$AUTHOR[df_elements] <- lapply(x$AUTHOR[df_elements], 
      trimws)
  }
  names(x) <- toupper(names(x))
  fields <- lapply(seq_len(nrow(x)), function(r) {
    rowfields <- rep(list(character(0)), ncol(x))
    names(rowfields) <- names(x)
    for (i in seq_along(rowfields)) {
      f <- x[[i]][r]
      if (is.list(f)) {
        f <- unlist(f)
      }
      rowfields[[i]] <- if (!length(f) | any(is.na(f))) {
        character(0L)
      }
      else if (names(x)[i] %in% c("AUTHOR", "EDITOR")) {
        paste(f, collapse = " and ")
      }
      else {
        paste0(f, collapse = ", ")
      }
    }
    rowfields <- rowfields[lengths(rowfields) > 0]
    rowfields <- rowfields[!names(rowfields) %in% c("CATEGORY", 
      "BIBTEXKEY")]
    if (allfields) {
      paste0("  ", names(rowfields), " = {", unname(unlist(rowfields)), 
        "}", collapse = ",\n")
    }
    else {
      paste0("  ", names(rowfields[nzchar(rowfields)]), 
        " = {", unname(unlist(rowfields[nzchar(rowfields)])), 
        "}", collapse = ",\n")
    }
  })
  write_utf8(paste0("@", bib2df:::capitalize(x$CATEGORY), "{", x$BIBTEXKEY, 
    ",\n", unlist(fields), "\n}\n", collapse = "\n\n"), 
    con = file)
  invisible(file)
}
```


Write file

```{r}
df2bib(bibPubs, "Villarreal-Pubs.bib")
```



# Text processing for Rds/csv

Handle `\`, `\textit{}`


# Write Rds



# Write csv

Remove formatting marks (`_{}`)





# Session info

```{r}
sessionInfo()
```

